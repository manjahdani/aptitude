/** 
 * 
 */
package be.uclouvain.aptitude.surveillance

import io.sarl.core.Behaviors
import io.sarl.core.Destroy
import io.sarl.core.InnerContextAccess
import io.sarl.core.Lifecycle
import io.sarl.core.Logging
import io.sarl.core.Schedules

/** 
 * @author manjah
 * 
 */
 
event CommitSuicide

agent Paraddis {
	uses Lifecycle, Logging, InnerContextAccess, Schedules, Behaviors

	protected var AgentType : String = 'Unknown'
	
//on Initialize {
	//	// Event trigger before the agent begin to live or to be used.
	//
	//				/* 
	//	 * The goal in the statements below is to help us setting the AgentType in 
	//	 * order to have an idea of which agents is producing which <<log
	//	 */
	//	val Classa = this.class.toString // to get the class of the agent
	//	 synchronized (AgentType)
	//	 switch (Classa) {
	//	 case "class be.uclouvain.launcher.bootAgent": {
	//	  AgentType = "Boot"}
	//	  case "class be.uclouvain.aptitudeAgents.PlatformAgent":{
	//	  	AgentType="Platform"
	//	  }
	//	  default:{
	//	  	AgentType ='AgentNotKnown' 
	//	  	info(Classa)
	//	  	}}
	//
	//	loggingName = AgentType + "-" + this.ID
	//	 synchronized (AgentType)
	//info(" agent was started.")
	//}
	on Destroy {
		// synchronized (AgentType)
			info("agent was stopped.")
	}

	on CommitSuicide {

		/* 
		 * When receiving this, the agent tries
		 * 1. to cancel all the tasks he was busy with
		 * 2. 
		 * 
		*/
		
		info("I received a CommitSuicide : " + occurrence.fromMe + " : " +occurrence.source.UUID) 

		

		if (hasMemberAgent) {
			
			if(!getActiveTasks.contains("wait-task"))
			{
				val waitTask = task("wait-task")
				waitTask.every(2000) [
				if (!hasMemberAgent) {
					if (!getActiveTasks.isEmpty) {
						for (e : getActiveTasks) {
							info("task in progress" + e)
							task(e).cancel
						}
						info("Done cancelling " + getActiveTasks)}
					waitTask.cancel
					killMe
				} else {
					innerContext.defaultSpace.emit(this.ID,new CommitSuicide)[it!=me]
				}
			]
		}
		}
		else {
			if (!getActiveTasks.isEmpty) {
				for (e : getActiveTasks) {
					task(e).cancel
				}
				info("Done cancelling " + getActiveTasks)
			}
			killMe
		}
	}
}
