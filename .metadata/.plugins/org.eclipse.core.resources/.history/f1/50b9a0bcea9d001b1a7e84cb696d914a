/** 
 */
package be.uclouvain.organisation.platform

import be.uclouvain.organisation.OrganisationInfo
import io.sarl.core.Behaviors
import io.sarl.core.DefaultContextInteractions
import io.sarl.core.Destroy
import io.sarl.core.Initialize
import io.sarl.core.Logging
import io.sarl.core.OpenEventSpace
import io.sarl.lang.core.AgentContext
import java.util.UUID
import java.util.concurrent.atomic.AtomicInteger
import be.uclouvain.organisation.PlatformOrganisationInfo
import be.uclouvain.organisation.TOLDOrganisationInfo

/** 
 * Receives data at a certain stage (Raw, Information, Knowledge, Insight) and process it. 
 * Observers are distinct if they process a different Signal or use another Model or both .
 * 
 * It Becomes a multi-layer concept if it involves several entities observing the same target(data).
 * A possible Holonic configuration could have the following layers : 
 * 
 * 			- Multiple Sensors at different location analysing the same scene
 *          - Multiple Algorithms with different beliefs analysing the same signal. 
 * 
 * Example : let's take a junction equipped with three cameras (C_1  ,C_2,C_3) aiming to provide a list of the cars in the scene. 
 * The cameras dispose two algorithms models (M_1 ,M_2). Let us assume, that C_1  uses M_1and M_2 to process the data while others only use M_1. 
 * You have four Observers (O_1,O_2,O_3,O_4) = (C_1 M_1; C_1 M_2; C_2 M_1; C_3 M_1). 
 * A stable and scalable approach would consider two supplementary Observers to gather this as a Holonic system. 
 * On the one hand an Observer O_5 concatenating the perceptions of O_1, O_2 and on the other hand, a sixth Observer for the perceptions of O_5 O_3 O_4. 
 * Notice that Observers O_1and O_2 became Signals for O_5, becoming itself a signal for O_6. 
 * 
 * @author $Author: manjahdani$
 * @version $0.1$
 * @date $31/03/2021$
 * @mavengroupid $be.uclouvain.aptitude$
 * @mavenartifactid $organisation$
 */
 
behavior ObserverRole {
	
	uses Logging, Behaviors, DefaultContextInteractions

	protected var TOLDSpace : OpenEventSpace
	protected var TOLDID : UUID
	protected var PlatformContext : AgentContext

	protected var observerID : UUID
	protected var sensitivity = new AtomicInteger()
	
	@SuppressWarnings("potential_field_synchronization_problem")
	on Initialize {
		observerID = occurrence.parameters.get(1) as UUID
	}

	on Destroy {
		info("The behavior was stopped.")
	}

	@SuppressWarnings("potential_field_synchronization_problem")
	on PlatformOrganisationInfo  { 
		
		PlatformContext = occurrence.context
		TOLDID = occurrence.source.getUUID
		TOLDSpace = occurrence.spaceID
		TOLDSpace.register(asEventListener)
		emit(new SensititvityRequest)[it.UUID==observerID]
	}
	
	on TOLDOrganisationInfo{
		
	}

	on SensititvityRequest {
		info("Thank you for joining the mission. Please use the following sensitivity" + sensitivity.get)
		//info("I received A Sensititivy Request" + occurrence.source.UUID)
		emit(new MissionSensitivity(sensitivity.get)
		)[it.UUID == occurrence.source.UUID]
	}

	on StopMission {
		if (occurrence.source.UUID == observerID) {
			info("I received the StopMission")
			emit(new StopMission(occurrence.expertID))
			emit(new LeavePlatform)[it==me]
		}
	}
	
		@SuppressWarnings("potential_field_synchronization_problem")
		on LeavePlatform {
		//join(BaseContext.ID, BaseSpace.spaceID.ID)
		info("ObserverLeaving")
		//leave(PlatformContext.ID)
	}
}
