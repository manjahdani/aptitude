/** 
 * 
 */
package be.uclouvain.launcher

import UDPMessages.MessageDeserializer
import UDPMessages.UDP_Message_Base

import be.uclouvain.organisation.platform.util.PlatformConfig
import io.sarl.core.DefaultContextInteractions
import io.sarl.core.Initialize
import io.sarl.core.Lifecycle
import io.sarl.core.Logging
import io.sarl.core.Schedules
import java.net.DatagramPacket
import java.net.DatagramSocket
import javafx.application.Application
import be.uclouvain.aptitude.surveillance.Paraddis
import be.uclouvain.aptitude.surveillance.CommitSuicide
import be.uclouvain.aptitude.surveillance.PlatformAgent
import be.uclouvain.aptitude.surveillance.ApplicationVaadin

/** 
 * @TODO: The holarchy needs rethinking. 
 * 
 * @author $Author: manjahdani$
 * @version $0.0.1$
 * @date $31/03/2021$
 * @mavengroupid $be.uclouvain.aptitude$
 * @mavenartifactid $organisation$
 */
agent bootAgent extends Paraddis {
	uses Lifecycle, Schedules, DefaultContextInteractions, Logging

	//val junctionList = "MacqWoolridge"

	val client : DatagramSocket = new DatagramSocket(65000) // A client to listen requests
	//val clientSender = new UDPSender() // homeMade client to send UDP message

	on Initialize {
		loggingName = "Boot" + "-" + this.ID
		info("Universe started")
		setAgentsReady()
		enableInputStream()

		task("Application-Launcher").execute[Application::launch(GUI, " ")]
		
		ApplicationVaadin.runFrontend()
	}
	
	//@FIXME We absolutely need to extend the Universe Concept. We need a global database.. with local d.b. Need Rethinking
	def setAgentsReady {
		
		// for (wc : subWorldConfig) {
		// WorldHolon.addSubWorld(wc)
		// }
		//info("Setting the agents")
		var PlatformHolonConfig = new PlatformConfig(5, 0)
		PlatformHolonConfig.addSubPlatform(new PlatformConfig(100, 1))
		spawn(PlatformAgent, PlatformHolonConfig)
		// StartSimulation
	}

	def MessageAnalysis(msg : UDP_Message_Base, adrss : String) {

		switch (msg.method) {
			case "stopSimulation": {
				disable()
				emit(new CommitSuicide)
			}
			default: {
				info("Unknown message received by boot agent : " + msg.method)
			}
		}
	}

	def synchronized enableInputStream {
		var parser = new MessageDeserializer();
		val Enable_Server = task("Enable_Server")
		Enable_Server.execute([
			while (!isCanceled(Enable_Server) && !client.isClosed) {
				var buffer = newByteArrayOfSize(8192);
				var packet = new DatagramPacket(buffer, buffer.length);
				client.receive(packet);
				var message = new String(packet.getData(), packet.getOffset(), packet.getLength());
				var data : UDP_Message_Base = parser.Deserialize(message);
				if (data !== null) {
					MessageAnalysis(data, (packet.getAddress()).getHostAddress)
				} else {
					info("I received it NULLL" + data)
				}
				packet.setLength(buffer.length);
			}
		])

	}
	def synchronized disable() {
		this.client.close()
		task("Enable_Server").cancel
		task("Application-Launcher").cancel
	}
}
