/** 
 * 
 */
package be.uclouvain.aptitude.surveillance.evaluation

import be.uclouvain.aptitude.surveillance.algorithm.LastFrame
import be.uclouvain.aptitude.surveillance.algorithm.counter.CounterRole
import be.uclouvain.aptitude.surveillance.algorithm.tracker.TrackingRequest
import be.uclouvain.aptitude.surveillance.algorithm.util.EvaluationResults
import be.uclouvain.aptitude.surveillance.algorithm.util.Metric
import be.uclouvain.python_access.EvaluationResult
import be.uclouvain.python_access.PartnerEvaluationFound
import be.uclouvain.python_access.PythonAccessorRole
import be.uclouvain.python_access.messages.EvaluationMessage
import io.sarl.core.Behaviors
import io.sarl.core.DefaultContextInteractions
import io.sarl.core.Initialize
import io.sarl.core.Logging
import java.nio.file.Files
import java.nio.file.Paths
import java.util.UUID

/** 
 * @TODO : To complete
 * 
 * @author  $ manjahdani$
 * @version $0.0.1$
 * @date $17/06/2021$
 * @mavengroupid $be.uclouvain.aptitude$
 * @mavenartifactid $surveillance$
 * 
 */
behavior AlgorithmSelectorRole extends PythonAccessorRole {
	
	uses AlgorithmSelection, Behaviors, Logging, Evaluation, DefaultContextInteractions  
	
	protected var compDuration : long
	protected var numberTests = 0 
	
	protected var score : Metric; 
	protected var gts : String
	
	on Initialize {

		score = occurrence.parameters.get(3) as Metric
		gts = new String(Files.readAllBytes(Paths.get(score.gtFilePatch)))
		setSkill(new AlgorithmSelectionSkill(score.params), AlgorithmSelection)
}

	
	on PartnerEvaluationFound {
		partnerName = occurrence.partnerName
		//info("I found my partner" + partnerName)
		this.compDuration = System.currentTimeMillis()
	}

	
	on LastFrame {
		debug("Obtained the path to observations " + occurrence.pred_file_Path + " that stopped at frame " + occurrence.frameNumber)
		info("Sending to evaluation")
		var predictions = new String(Files.readAllBytes(Paths.get(occurrence.pred_file_Path)));
		var testID = UUID.randomUUID
		addResult(testID,
			new EvaluationResults(occurrence.observerID, occurrence.pred_file_Path, occurrence.total_time_detection,
				occurrence.total_time_tracking, occurrence.frameNumber))
		sendEvaluationRequest(testID.toString, predictions, gts)
	}

	/* 
	 * @FIXME HIGH Not general
	 */
	on EvaluationResult {

		synchronized (this) {
			 info("Message Evaluation Received")
			if (addResult(occurrence.result.requestID, occurrence.result)) {
				numberTests += 1
				info("Recording the result of Competitor " + numberTests)
				if (numberTests == 2) {
					var selected = selectAlgorithm()
					emit(new TrackingRequest(selected.competitorID))
					registerBehavior(new CounterRole(owner))
				}
			}
			else{
				info("Could not succed to add " +occurrence.result.uuid)
			}
			}
			// print(Result) 
	}
	
	def print(result : EvaluationMessage) {
		
		 info("HOTA \t" + result.HOTA,'\n'+
		 "DetA \t" + result.detA,'\n'+
		 "AssA \t" + result.assA,'\n'+
		 "DetRe \t" + result.detRe,'\n'+
		 "DetPr \t" + result.detPr,'\n'+
		 "AssRe \t" + result.assRe,'\n'+
		 "AssPr \t" + result.assPr,'\n'+
		 "LocA \t" + result.locA,'\n')
	}
}
